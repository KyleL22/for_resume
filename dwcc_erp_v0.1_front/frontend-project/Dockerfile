# Stage 1: Build
FROM node:20-alpine AS build
LABEL authors="onerp_adm"

WORKDIR /app

# íŒ¨í‚¤ì§€ íŒŒì¼ ë³µì‚¬ ë° ì˜ì¡´ì„± ì„¤ì¹˜
COPY package*.json ./
RUN npm ci

# ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬
COPY . .

# Translation íŒŒì¼ ìƒì„± (API ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ë³¸ íŒŒì¼ ì‚¬ìš©)
RUN if [ -f translations.json ] && [ -s translations.json ]; then \
        node scripts/generate-translations.cjs translations.json && echo "Translation files generated from API data" || echo "Using default translation files"; \
    else \
        echo "Using default translation files"; \
    fi

# ë¹Œë“œ ì‹œ í™˜ê²½ ë³€ìˆ˜ëŠ” ARGë¡œ ì „ë‹¬ë°›ì•„ ì‚¬ìš©
ARG VITE_API_BASE_URL
ARG VITE_API_PROXY_TARGET
ARG VITE_ENV
ENV VITE_API_BASE_URL=$VITE_API_BASE_URL
ENV VITE_API_PROXY_TARGET=$VITE_API_PROXY_TARGET
ENV VITE_ENV=$VITE_ENV

# ë¹Œë“œ ì‹œ í™˜ê²½ë³€ìˆ˜ í™•ì¸ ë¡œê·¸
RUN echo "ğŸ”¨ Building for environment: $VITE_ENV" && \
    echo "   API Base URL: $VITE_API_BASE_URL" && \
    echo "   Proxy Target: $VITE_API_PROXY_TARGET"

RUN npm run build

# Stage 2: Production
FROM nginx:alpine

# íƒ€ì„ì¡´ ì„¤ì •
RUN apk add --no-cache tzdata && \
    cp /usr/share/zoneinfo/Asia/Seoul /etc/localtime && \
    echo "Asia/Seoul" > /etc/timezone && \
    apk del tzdata

# ë¹Œë“œëœ íŒŒì¼ì„ nginxì— ë³µì‚¬
COPY --from=build /app/dist /usr/share/nginx/html

# nginx ì„¤ì • íŒŒì¼ ìƒì„± (SPA ë¼ìš°íŒ… ì§€ì›)
RUN echo 'server { \
    listen 80; \
    server_name _; \
    root /usr/share/nginx/html; \
    index index.html; \
    location / { \
        try_files $uri $uri/ /index.html; \
    } \
}' > /etc/nginx/conf.d/default.conf

# 80 í¬íŠ¸ ë…¸ì¶œ
EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]

